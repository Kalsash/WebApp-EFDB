@using Humanizer
@model WebApp_Feed.Models.FeedViewModel

@{
    ViewData["Title"] = "Home Page";
}
@functions {
    public DateTime ConvertByteArrayToDateTime(byte[] byteArray)
    {
        if (byteArray == null || byteArray.Length != 8)
        {
            throw new ArgumentException("Byte array must be 8 bytes long.");
        }

        long dateTimeBinary = BitConverter.ToInt64(byteArray, 0);
        return DateTime.FromBinary(dateTimeBinary);
    }

    public string GetTimeAgo(DateTime postDate)
    {
        var timeDifference = DateTime.Now - postDate;

        if (timeDifference.TotalMinutes < 1)
        {
            return "Just now";
        }
        else if (timeDifference.TotalMinutes < 60)
        {
            return $"{(int)timeDifference.TotalMinutes} minute{(timeDifference.TotalMinutes > 1 ? "s" : "")} ago";
        }
        else if (timeDifference.TotalHours < 24)
        {
            return $"{(int)timeDifference.TotalHours} hour{(timeDifference.TotalHours > 1 ? "s" : "")} ago";
        }
        else
        {
            return $"{(int)timeDifference.TotalDays} day{(timeDifference.TotalDays > 1 ? "s" : "")} ago";
        }
    }

    public string GetEnglishMonthAbbreviation(DateTime date)
    {
        return date.ToString("MMM", System.Globalization.CultureInfo.InvariantCulture).ToUpper();
    }
}

<!-- Main Feed Container -->
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-0 lg:divide-x sm:divide-y lg:h-[calc(100vh-4rem)]">

        <!-- Left Sidebar -->
        <div class="lg:col-span-1 bg-white order-1">
            <div class="p-6 space-y-4">
                <div class="flex items-center space-x-2">
                    <img src="green-toad-logo.svg" alt="Greenswamp Logo" class="h-8 w-8">
                    <span class="text-2xl font-bold text-swamp-600">Greenswamp</span>
                </div>
                <div class="space-x-2">
                    <a href="register.html">
                        <button class="bg-swamp-500 font-semibold text-white px-4 py-2 rounded-full hover:bg-swamp-600">Register</button>
                    </a>
                    <a href="login.html">
                        <button class="bg-slate-200 font-semibold text-slate-900 px-4 py-2 rounded-full hover:bg-slate-300">Login</button>
                    </a>
                </div>
            </div>
        </div>

        <!-- Main Feed -->
        <div class="lg:col-span-2 divide-y order-3">
            <!-- Post Section -->
            @foreach (var post in Model.Posts)
            {
                <div class="bg-white shadow-sm p-6 mb-4">
                    <div class="flex items-start space-x-3">
                    @*     <img src="https://i.pravatar.cc/100?u=dorm23_frogs@pravatar.com" alt="User" class="w-16 h-16 rounded-full"> *@
                        <img src="@post.User.AvatarUrl" alt="User" class="w-16 h-16 rounded-full">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2">
                                <h4 class="font-semibold text-swamp-900">@post.User.DisplayName</h4>
                              @*   <span class="text-swamp-500">@post.CreatedAt.ToShortTimeString()</span> *@

                                <span class="text-swamp-500">
                                    @GetTimeAgo(ConvertByteArrayToDateTime(@post.CreatedAt))
                                </span>

                            </div>
                            <p class="mt-2 text-swamp-700">@post.Content</p>
                        
                            <div class="mt-4 flex items-center space-x-6 text-swamp-500">
                                <button class="flex items-center space-x-2 hover:text-swamp-600">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                    </svg>
                                    <span>2 Answers</span>
                                </button>
                                <button class="flex items-center space-x-2 hover:text-swamp-600">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    <span>Reribb</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            }

            <!-- Event Section -->
            @foreach (var eventItem in Model.Events)
            {
                <div class="bg-white shadow-sm p-6 mb-4 border-l-4 border-l-swamp-400">
                    <div class="flex items-start space-x-3">
                        <div class="w-10 h-10 bg-swamp-100 rounded-full flex items-center justify-center">
                            <svg class="text-swamp-600" fill="currentColor" viewBox="0 0 20 20"><path d="M10 3a7 7 0 100 14 7 7 0 000-14zm-2.5 9a.5.5 0 11-1 0 .5.5 0 011 0zm1-5.5a.5.5 0 011 0v5a.5.5 0 11-1 0v-5z" /></svg>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-semibold text-swamp-900">@eventItem.HostOrg</h4>
                            <p class="mt-2 text-swamp-700">Event Time: @ConvertByteArrayToDateTime(eventItem.EventTime).ToString("g")</p>
                            <p class="text-sm text-swamp-500">Location: @eventItem.Location</p>
                            <div class="mt-4 flex items-center space-x-4">
                                <button class="bg-swamp-500 text-white px-4 py-2 rounded-full text-sm hover:bg-swamp-600">RSVP</button>
                                <button class="text-swamp-600 hover:text-swamp-800 text-sm">Add to Calendar</button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Right Sidebar -->
        <div class="lg:col-span-1 bg-white sm:order-2 order-4">
            <!-- Search-->
            <div class="p-6 pb-0">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="w-5 h-5 text-swamp-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                    <input type="text" placeholder="Search" class="w-full pl-10 pr-4 py-2 bg-swamp-100 rounded-full border-none focus:ring-2 focus:ring-swamp-400 focus-visible:ring-swamp-400 placeholder:text-swamp-600">
                </div>
            </div>

            <!-- Trending Ponds -->
            <div class="p-6 pb-0">
                <h3 class="text-lg font-semibold text-swamp-900 mb-4">Trending Ponds</h3>
                <ul class="space-y-4">
                    <li>
                        <a href="#" class="flex items-center space-x-3 group">
                            <div class="w-8 h-8 bg-swamp-100 rounded-lg flex items-center justify-center">
                                <svg class="text-swamp-600" height="48px" width="48px" viewBox="0 0 20 20"><path fill="currentColor" d="M10 .5C4.755.5.5 4.755.5 10S4.755 19.5 10 19.5 19.5 15.245 19.5 10 14.245.5 10 .5zm0 18C5.48 18.5 1.5 14.52 1.5 10S5.48 1.5 10 1.5 18.5 5.48 18.5 10 14.52 18.5 10 18.5z" /></svg>
                            </div>
                            <h4 class="font-medium text-swamp-900 group-hover:text-swamp-600">#MidtermStudyGroup</h4>
                            <p class="text-sm text-swamp-500">1.2k posts</p>
                        </a>
                    </li>
                    <!-- Add more trending ponds -->
                </ul>
            </div>

            <!-- Upcoming Events -->
            <div class="p-6 pb-0">
                <h3 class="text-lg font-semibold text-swamp-900 mb-4">Upcoming Events</h3>
                <div class="space-y-4">
                    @foreach (var eventItem in Model.Events
                    .OrderBy(e => ConvertByteArrayToDateTime(e.EventTime))
                    .Take(2))
                    {
                        <div class="flex items-start space-x-3">
                 
                            <div class="w-12 flex-shrink-0 text-center">
                                <div class="text-sm font-semibold text-swamp-600">@GetEnglishMonthAbbreviation(ConvertByteArrayToDateTime(@eventItem.EventTime))</div>
                                <div class="text-2xl font-bold text-swamp-900">@ConvertByteArrayToDateTime(@eventItem.EventTime).Day</div>
                            </div>
                            <div>
                                <h4 class="font-medium text-swamp-900">@eventItem.HostOrg</h4>
                                <p class="text-sm text-swamp-500">@eventItem.Location in @ConvertByteArrayToDateTime(@eventItem.EventTime).Hour PM</p>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <div class="p-6">
                <div class="flex items-start space-x-2 text-swamp-600">
                    <a href="#" class="hover:text-swamp-800">Contact</a>
                    <span>・</span>
                    <a href="privacy.html" class="hover:text-swamp-800">Privacy</a>
                    <span>・</span>
                    <a href="tos.html" class="hover:text-swamp-800">Terms</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Post Modal (Hidden by default) -->
<div id="postModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl max-w-2xl w-full p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold">New Ribbit</h3>
            <button onclick="closePostModal()" class="text-swamp-500 hover:text-swamp-700">×</button>
        </div>
        <textarea class="w-full p-4 border border-swamp-200 rounded-lg focus:ring-2 focus:ring-swamp-400 focus:border-transparent" rows="4" placeholder="What's hopping?"></textarea>
        <div class="mt-4 flex justify-between items-center">
            <button class="p-2 hover:bg-swamp-100 rounded-lg">Add Frogmoji</button>
            <button class="bg-swamp-500 text-white px-6 py-2 rounded-full hover:bg-swamp-600">Send Ribbit</button>
        </div>
    </div>
</div>

<script>
    function openPostModal() {
        document.getElementById('postModal').classList.remove('hidden');
    }

    function closePostModal() {
        document.getElementById('postModal').classList.add('hidden');
    }
</script>